---
title: AWS IoT Core
description: Connecting IoT Core with Waylay
weight: 1
---

# Connecting AWS IoT Core to Waylay

## Prerequisites

* Access to AWS IoT Core and Lambda
* Account on AWS with permissions to IoT Core and Lambda
* IoT connected device
* Access to the Waylay platform

The main building blocks of this integration are presented below:
![architecture](/features/iothubs/architecture.png)

## Configuring AWS IoT Core

## Device registry

To register your device, you need to create a thing AWS IoT Core.

1. Choose `Manage` under IoT Core.
  * If you don't have a thing yet, choose `Register a thing`.
![no-things-yet](/features/iothubs/no-things-yet.png)
  * If you have a thing, choose `Create`.
![already-things](/features/iothubs/already-things.png)
2. Choose `Create a single thing`
{{% alert info %}}
Note: for mass deployment you can choose `Create many things`
{{% /alert %}}
3. Choose a name and choose `Next`

## Device certification

Communication between your device and AWS IoT is protected through the use of x.509 certificates. You can choose to use certificates generated by AWS IoT, or use your own.

1. Choose `Create certificate`.
2. On the next page, choose `Download` for the certificate, private key and root CA. Then choose `Activate`.

## Policy creation

For your device to be able to do anything with the certificates we created in the previous step, you need to link them to a policy. A policy dictates what a device can and can’t do.

1. In the left navigation pane, choose `Secure`, and then `Policies`.

  * If you don't have any policies yet, choose `Create a policy`.

![no-policy-yet](/features/iothubs/no-policy-yet.png)
  * If you have a policy, choose `Create`.
![already-policy](/features/iothubs/already-policy.png)
2. Choose a `Name`, in the `Action` field, type `iot:Connect`. In the `Resource ARN` field, type `*`. Select the Allow checkbox.
{{% alert info %}}
Note: This allows all clients to connect to AWS IoT
{{% /alert %}}
3. Select the `Add statement` button. In the `Action` field, type `iot:Publish`. In the `Resource ARN` field, type the ARN of the topic to which your device will publish.
{{% alert info %}}
Note: The topic ARN follows this format:
arn:aws:iot:_your-region:your-aws-account_:topic/_my/topic/here_
{{% /alert %}}
4. Select the `Allow` check box.
{{% alert info %}}
Note: This allows the device to publish messages to the specified topic.
{{% /alert %}}
5. Choose `Create`

## Attach a policy to a device certificate

You need to attach the policy to a device certificate for it to take effect.

1. In the left navigation pane, choose `Secure`, and then `Certificates`.
2. In the box for the certificate you created, choose `...` to open a drop-down menu, and then choose `Attach policy`.
3. Select the check box next to the policy you wish to add, and then choose `Attach`.

## Attach a certificate to a Thing

A device needs certificates to authenticate with AWS IoT. It is recommended to attach the certificates to the Thing that represents your device on AWS IoT. This allows you to create policies that are in effect for this device.
To attach a certificate to the thing in your registry:

1. In the box for the certificate you created, choose `...` to open a drop-down menu, and then choose `Attach thing`.
2. Select the check box next to the thing you registered, and then choose `Attach`.

## Create a rule

AWS IoT rules consist of a topic filter, a rule action, and, in most cases, an IAM role. Messages published on topics that match the topic filter will trigger the rule. For this example we will create a rule that triggers a lambda to go to the Waylay platform.

1. Choose `Act` under the IoT Core console.
2. Choose `Create a rule`.
3. Provide a `Name`, `Description` and `SQL version`.
4. In the `Attribute` field, type `*`.
{{% alert info %}}
Note: * specifies to send the entire MQTT message that triggered this rule.
{{% /alert %}}
5. In the `Topic filter` field, type the topic used in the rule. Leave `Condition` blank.
6. Choose `Add action`, select `Invoke a Lambda function passing the message data` and then choose `Configure action`
7. Choose `Create a new resource`, select `Author from scratch`. Provide a `Name` and `Role` for your function. 
8. Choose `Create function`.
9. Go back to the rule you were creating and refresh the function list. Choose the function you created and choose `Add action`.
10. Choose `Create rule`.
11. In the `Designer` under the function you created, choose the `Lambda` you created earlier. This is example code used to send data to Waylay.
{{% alert info %}}
Note: To add dependencies to Lambda you need to make them in another program (eg. visual studio code) and upload your folder as a zip file to Lambda.
{{% /alert %}}
12. Choose `Save` at the top right of the screen.

```javascript
// Require the Waylay Client
const Waylay = require('@waylay/client')

// Set the domain value
const domain = ${customerDomain}
    
// Generate a token to authenticate
const token = ${yourtoken}

exports.handler = function(event) {
    
    // Instantiate the Waylay Client
    const waylay = new Waylay({
        domain,
        token
        })
        
    const deviceID = event.deviceID

    const { data } = event

    waylay.data.baseUrl = 'https://data-${customerDomain}'

    // Post the data in a form of series to Waylay
    waylay.data.postSeries(deviceID, data)

}
```
For more information on the Waylay client package:

https://www.npmjs.com/package/@waylay/client

You've now finished setting up the AWS side of the connection.

## Check if data is being pushed to Waylay

Create the Lambda and push new data from your Device to your Topic. Now check if the data is arriving; Go to https://${customerDomain}/#/resources/${deviceId} and look up your resource with the DeviceId you specified. If all goes well you should see your data under data -> all messages

## Sending state back depending on what you configured in Waylay templates

Quick overview on how we implement Rules in Waylay:

![overview](/features/iothubs/overview.png)

The resource node (SENSOR) streams data from a particular resource. (Your resource’s data is being pushed on whatever frequency you push data from your device to the Google Pub/Sub Topic). The Sensor has in this examples 2 boundaries; Above and Below, when its Above or Below a specific value it activates or deactivates a light. This actuation is just a simple Message that is pushed to a Topic that your device can listen to in order to take action depending on the message.

To make a Template yourself go to the end of the page and see section **testing standard template**

For further information on how the Designer, Sensors and Actuators work go to: https://docs.waylay.io/api/sensors-and-actuators/

## Allowing Waylay to publish to your topics

To make it possible for Waylay to publish to your topics, you need to give it access to your AWS resources. The best way to do this is through External ID, which you can use in an IAM role trust policy to designate who can assume the role.

You can read more about it here: 
https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-user_externalid.html

Next you need to get an Access Key ID and a Secret Key, as seen in this guide:
https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/getting-your-credentials.html?shortFooter=true

## Actuating back to your state IoT topic

In the Waylay designer search for: `AWSIoTCoreWebscriptActuator`

Parameters to provide in the actuator:

* Waylay webscript URL: Webscript URL of the Webscript with the code below
* AWS IoT topic name
* Access Key ID
* Secret Key
* JSON to publish ex.: `{"lightValue":"600"}`
* Region your AWS IoT Core is located in
* Endpoint url of your AWS IoT Core

## Testing a standard template

### Webscript:

Import dependency: `aws-sdk` version: `^2.205.0`

```javascript
function handleRequest (req, res) {
  const { secretKey, accessKeyId, region, endpointUrl, topicname, json } = req.body

  const AWS=require('aws-sdk');
  AWS.config.region = region;
  AWS.config.accessKeyId = accessKeyId;
  AWS.config.secretAccessKey = secretKey;
  const iotdata = new AWS.IotData({endpoint: endpointUrl});  


  function publishData() {
    const jsonData = JSON.stringify(body)
    const dataBuffer = Buffer.from(jsonData, 'utf8')
  
    var params = {
      topic: topicname,
      payload: dataBuffer,
      qos: 0
    };
    iotdata.publish(params, function(err, data) {
      if (err) console.log(err, err.stack); // an error occurred
        else     
          console.log("Message published:" + data);
          res.sendStatus(200)// successful response
    });
  }

  publishData()
}
```